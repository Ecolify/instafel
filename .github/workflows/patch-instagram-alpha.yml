# Workflow: Patch Instagram Alpha
# 
# This workflow automates the process of downloading Instagram Alpha APKs and patching them with Instafel.
# 
# Usage:
#   1. Manual trigger via workflow_dispatch with APK URL input (recommended)
#   2. Automatic download via gplayapi (requires GitHub Secrets configuration)
#
# Outputs:
#   - Patched Instagram APK files (clone and unclone variants)
#   - Build metadata JSON files
#
# See .github/workflows/README.md for detailed documentation

name: Patch Instagram Alpha

on:
  push:
    branches: ["**"]            # Todas las ramas, incluidas copilot/*
  workflow_dispatch:       
    inputs: # EjecuciÃ³n manual
      instagram_apk_url:
        description: 'Instagram Alpha APK download URL (required if not using gplayapi)'
        required: false
        type: string
        default: 'https://www.dropbox.com/scl/fi/z0h72z7nex5kzfvwc1s2d/insap.apk?rlkey=moj92yjt99pjzbzqur9fv1meb&st=ozle68lo&dl=1'
      use_gplayapi:
        description: 'Use gplayapi to download latest Instagram Alpha (requires secrets)'
        required: false
        type: boolean
        default: false
  workflow_call:                # Llamado por otros workflows

jobs:
  patch-instagram:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      attestations: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
      
      - name: Build Instafel App (Release)
        id: build-app
        run: |
          echo "Building Instafel App (Release)..."
          ./gradlew :app:generate-app-debug
          ls -lh .output/
      
      - name: Regenerate ifl_sources and ifl_resources zips
        id: regenerate-zips
        run: |
          echo "Regenerating ifl_sources.zip and ifl_resources.zip with latest code changes..."
          
          # Build the patcher-core first to get CreateIflZip job
          ./gradlew :patcher-core:build-jar
          
          # Build the patcher to run the init command
          ./gradlew :patcher:build-jar
          
          # Copy core JAR so patcher can find it locally
          cp .output/ifl-patcher-core-*.jar .
          
          # Run patcher init on the built Instafel app to generate updated zips
          echo "Running patcher init to extract smali and resources..."
          java -jar .output/ifl-patcher-v*.jar init .output/app-debug.apk || {
            echo "Patcher init failed, but continuing with existing zips..."
            echo "This is expected if network access is required for core download."
          }
          
          # Check if new zips were generated
          APK_DIR=$(ls -d app-debug* 2>/dev/null | head -n 1)
          if [ -n "$APK_DIR" ] && [ -f "$APK_DIR/ifl_sources.zip" ]; then
            echo "New zips generated successfully!"
            echo "Copying to patcher-core resources..."
            cp "$APK_DIR/ifl_sources.zip" patcher-core/src/main/resources/ifl_sources/
            cp "$APK_DIR/ifl_resources.zip" patcher-core/src/main/resources/ifl_sources/
            cp "$APK_DIR/ifl_data.xml" patcher-core/src/main/resources/ifl_sources/
            echo "Updated zip files:"
            ls -lh patcher-core/src/main/resources/ifl_sources/
          else
            echo "Using existing zip files from repository"
            ls -lh patcher-core/src/main/resources/ifl_sources/
          fi
      
      - name: Build Patcher Core (with updated zips)
        id: build-patcher-core
        run: |
          echo "Rebuilding Patcher Core with updated zips..."
          ./gradlew :patcher-core:build-jar --rerun-tasks
          ls -lh .output/
      
      - name: Build Instafel Patcher
        id: build-patcher
        run: |
          echo "Building Instafel Patcher..."
          ./gradlew :patcher:build-jar
          ls -lh .output/
      
      - name: Setup gplayapi and download (if enabled)
        id: build-gplayapi
        run: |
          echo "Setting up gplayapi to download Instagram Alpha..."
          
          # Create config.properties file from GitHub Secrets
          cat > config.properties << EOF
          email=${{ secrets.GPLAY_EMAIL }}
          aas_token=${{ secrets.GPLAY_AAS_TOKEN }}
          github_pat=${{ secrets.GH_TOKEN }}
          EOF
          
          # Build gplayapi downloader
          echo "Building gplayapi downloader..."
          ./gradlew :gplayapi:downloaderJar
          ls -lh .output/

      - name: Download Instagram Alpha APK (Direct URL)
        run: |
          echo "Downloading Instagram APK from provided URL..."
          curl -L -o instagram.apk "https://www.dropbox.com/scl/fi/z0h72z7nex5kzfvwc1s2d/insap.apk?rlkey=moj92yjt99pjzbzqur9fv1meb&st=hfilmv2i&dl=1"
          ls -lh instagram.apk
      
      - name: Validate APK exists
        run: |
          if [ ! -f instagram.apk ]; then
            echo "Error: instagram.apk not found"
            echo "Please provide instagram_apk_url parameter"
            exit 1
          fi
          echo "APK file validated:"
          ls -lh instagram.apk
      
      - name: Setup patcher environment
        run: |
          # Copy core JAR to current directory so patcher can find it locally
          cp .output/ifl-patcher-core-*.jar .
          echo "Core JAR copied to current directory:"
          ls -lh ifl-patcher-core-*.jar

          
      - name: List Instafel patches
        run: |
          # Run init command to extract and prepare the APK
          java -jar .output/ifl-patcher-v*.jar list
          
      - name: Initialize Instafel project
        run: |
          # Run init command to extract and prepare the APK
          java -jar .output/ifl-patcher-v*.jar init instagram.apk
          
          # Verify project was created
          PROJECT_DIR=$(ls -d instagram* 2>/dev/null | head -n 1)
          if [ -z "$PROJECT_DIR" ]; then
            echo "Error: Project directory not found after init"
            ls -la
            exit 1
          fi
          
          echo "Project initialized successfully: $PROJECT_DIR"
          ls -la "$PROJECT_DIR"
      
      - name: Apply patches (unclone variant)
        id: apply-patches
        run: |
          # Find the project directory
          PROJECT_DIR=$(ls -d instagram* 2>/dev/null | head -n 1)
          if [ -z "$PROJECT_DIR" ]; then
            echo "Error: Project directory not found"
            exit 1
          fi
          
          echo "Applying Instafel patches (unclone variant) to: $PROJECT_DIR"
          java -jar .output/ifl-patcher-v*.jar run "$PROJECT_DIR" instafel ghost_mode remove_snooze_warning unlock_developer_options change_channel_name remove_ads clone
          
          echo " patches applied successfully"
      
      - name: Build patched Instagram APK (unclone variant)
        id: build-patched-apk
        run: |
          # Find the project directory
          PROJECT_DIR=$(ls -d instagram* 2>/dev/null | head -n 1)
          if [ -z "$PROJECT_DIR" ]; then
            echo "Error: Project directory not found"
            exit 1
          fi
          
          echo "Building patched APK (unclone variant) for: $PROJECT_DIR"
          java -jar .output/ifl-patcher-v*.jar build "$PROJECT_DIR"
          
          # Verify build output
          if [ ! -d "$PROJECT_DIR/build" ]; then
            echo "Error: Build directory not created"
            exit 1
          fi
          
          echo "Build completed successfully (unclone variant)"
          echo "Build output:"
          ls -lh "$PROJECT_DIR/build/"
          mkdir out
          cp .output/*.apk out/
          cp .output/*.jar out/
          echo "CURRENT_PATH=$(pwd)" >> $GITHUB_ENV
          echo "Ruta actual guardada: $CURRENT_PATH"

      
      - name: Upload Instafel App APKs
        if: success() && steps.build-app.outcome == 'success'
        uses: actions/upload-artifact@v5
        with:
          name: instafel-app-latest
          path: ${{ env.CURRENT_PATH }}/out/*.apk
          include-hidden-files: true
          if-no-files-found: warn
      
      - name: Upload Instafel JAR artifacts
        if: success() && (steps.build-patcher-core.outcome == 'success' || steps.build-patcher.outcome == 'success' || steps.build-gplayapi.outcome == 'success')
        uses: actions/upload-artifact@v5
        with:
          name: instafel-jar-latest
          path: ${{ env.CURRENT_PATH }}/out/*.jar
          include-hidden-files: true
          if-no-files-found: warn
      
      - name: Upload patched Instagram APKs
        if: success() && steps.build-patched-apk.outcome == 'success'
        uses: actions/upload-artifact@v5
        with:
          name: instafel-patched-instagram-latest
          path: instagram*/build/*.apk
          if-no-files-found: warn
      
      - name: Upload build info
        if: success() && steps.build-patched-apk.outcome == 'success'
        uses: actions/upload-artifact@v5
        with:
          name: instafel-build-info-latest
          path: instagram*/build/*.json
          if-no-files-found: warn
